<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <link rel="icon" href="favicon.ico" type="image/x-icon">
    <link rel="stylesheet" href="styles.css">
    <script src="toast.js" defer></script>
    <title>Dashboard – Completionist Tracker</title>

    <!-- Prevent flash before auth check -->
    <style>
        html {
            visibility: hidden
        }
    </style>

    <!-- Auth guard: runs BEFORE anything else -->
    <style>
        html {
            visibility: hidden
        }
    </style>
    <script>
        (async () => {
            const LOGIN_PATH = '/login.html';
            const API = 'https://completionist-backend.onrender.com';
            const token = localStorage.getItem('token');
            const legacyUserId = localStorage.getItem('ct_user_id');

            const rememberDest = () => {
                try { sessionStorage.setItem('redirectAfterLogin', location.pathname + location.search + location.hash); } catch { }
            };
            const toLogin = () => { rememberDest(); location.replace(LOGIN_PATH); };

            // Preferred: token + server verify
            if (token) {
                try {
                    const res = await fetch(API + '/api/auth/me', { headers: { Authorization: 'Bearer ' + token } });
                    if (!res.ok) throw new Error('unauthorized');
                    window.currentUser = await res.json().catch(() => null);
                    document.documentElement.style.visibility = 'visible';
                    return;
                } catch {
                    localStorage.removeItem('token');
                    // fall through to legacy branch
                }
            }

            // Temporary legacy mode: allow if we only have ct_user_id (no token)
            if (legacyUserId) {
                console.warn('Running in legacy mode (no token). Add JWT to backend when possible.');
                document.documentElement.style.visibility = 'visible';
                return;
            }

            // No session—go to login
            toLogin();
        })();
    </script>

</head>

<body>
    <div class="container">
        <div class="topbar">
            <a href="index.html" class="brand">Completionist Tracker</a>
            <nav class="nav">
                <a class="link-btn btn-ghost" href="index.html">Dashboard</a>
                <a class="link-btn btn-ghost" href="community.html">Community</a>
                <button id="logoutBtn" class="btn-secondary">Log out</button>
            </nav>
        </div>

        <div class="panel wide-panel">
            <h1>My Dashboard</h1>
            <p class="section" style="color: var(--muted)">Track and manage your game progress.</p>

            <form id="gameForm" class="wide-form">
                <div class="form-row"
                    style="flex-direction:row;flex-wrap:wrap;gap:20px;align-items:flex-start;justify-content:space-between">
                    <input id="title" class="input" placeholder="Game Title" required autocomplete="off"
                        style="flex:2;min-width:240px">
                    <select id="run_type" class="input" required style="flex:1;min-width:160px">
                        <option value="">Run Type</option>
                    </select>
                    <select id="platform" class="input" required style="flex:1;min-width:160px">
                        <option value="">Platform</option>
                    </select>
                    <select id="genre" class="input" required style="flex:1;min-width:160px">
                        <option value="">Genre</option>
                    </select>
                    <input id="tags" class="input" placeholder="Tags (comma-separated)" autocomplete="off"
                        style="flex:2;min-width:240px">
                    <div style="display:flex;align-items:center;gap:12px;flex-basis:100%;margin-top:10px">
                        <button class="button" type="submit">Add Game</button>
                        <span id="flash" class="flash"></span>
                    </div>
                </div>
            </form>
        </div>

        <div class="section">
            <ul id="gameList" class="list"></ul>
        </div>
    </div>

    <script>
        const API = 'https://completionist-backend.onrender.com';
        const token = localStorage.getItem('token') || '';
        const userId = Number(localStorage.getItem('ct_user_id') || 0);

        const platforms = [
            'PC', 'PlayStation', 'PlayStation 2', 'PlayStation 3', 'PlayStation 4', 'PlayStation 5',
            'Xbox', 'Xbox 360', 'Xbox One', 'Xbox Series X/S', 'Nintendo Switch', 'Wii', 'Wii U',
            'GameCube', 'Nintendo 64', 'SNES', 'NES', 'Game Boy', 'Game Boy Advance', 'Nintendo DS',
            'Nintendo 3DS', 'PSP', 'PS Vita', 'Mobile', 'Other'
        ];

        const genres = [
            'RPG', 'JRPG', 'Action', 'Adventure', 'Action-Adventure', 'Platformer', 'Puzzle', 'Metroidvania',
            'Shooter', 'First-Person Shooter', 'Third-Person Shooter', 'Fighting', 'Racing', 'Strategy',
            'Real-Time Strategy', 'Turn-Based Strategy', 'Simulation', 'Sports', 'Stealth', 'Survival',
            'Survival Horror', 'Visual Novel', 'Rhythm', 'Sandbox', 'Open World', 'MMORPG', 'Roguelike',
            'Roguelite', 'Card Game', 'Other'
        ];

        const runTypes = [
            '100% Completion', 'Any%', 'Minimalist', 'Low% Run', 'Challenge Run', 'No Damage', 'No Death',
            'Permadeath / Ironman', 'Speedrun', 'Glitchless', 'Casual', 'New Game+', 'Custom'
        ];

        window.onload = () => {
            // Logout
            const logoutBtn = document.getElementById('logoutBtn');
            if (logoutBtn) {
                logoutBtn.addEventListener('click', () => {
                    localStorage.removeItem('token');
                    // Optional: clear app-specific IDs if your backend derives user from token
                    // localStorage.removeItem('ct_user_id');
                    try { sessionStorage.removeItem('redirectAfterLogin'); } catch { }
                    location.replace('/login.html');
                });
            }

            initDropdowns();
            loadGames();
            document.getElementById('gameForm').addEventListener('submit', handleSubmit);

            // Failsafe: if auth guard already showed the page, keep it; otherwise unhide.
            if (document.documentElement.style.visibility !== 'visible') {
                document.documentElement.style.visibility = 'visible';
            }
        };

        function initDropdowns() {
            fillDropdown('platform', platforms);
            fillDropdown('genre', genres);
            fillDropdown('run_type', runTypes);
        }

        function fillDropdown(id, options) {
            const select = document.getElementById(id);
            options.forEach(opt => {
                const o = document.createElement('option');
                o.value = opt;
                o.textContent = opt;
                select.appendChild(o);
            });
        }

        async function loadGames() {
            try {
                const res = await fetch(`${API}/api/games?user_id=${userId}`, {
                    headers: { Authorization: 'Bearer ' + token }
                });

                if (res.status === 401) return handleUnauthorized();

                const data = await res.json();
                const container = document.getElementById('gameList');
                container.innerHTML = '';

                if (!Array.isArray(data) || data.length === 0) {
                    container.innerHTML = `<p class="section" style="color:var(--muted)">No games found. Add one above.</p>`;
                    return;
                }

                data.forEach(game => {
                    const div = document.createElement('div');
                    div.className = 'card item';

                    const tagHTML = (game.tags || '')
                        .split(',')
                        .filter(Boolean)
                        .map(tag => `<span class="tag">#${escapeHtml(tag.trim())}</span>`)
                        .join(' ');

                    div.innerHTML = `
          <div style="display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap;gap:10px">
            <div>
              <div style="margin-bottom:10px">
                <div style="font-weight:700;margin-bottom:4px">
                  ${escapeHtml(game.title)}${game.run_type ? ` – ${escapeHtml(game.run_type)}` : ''}
                </div>
                <div style="color:var(--muted);font-size:13px">
                  ${escapeHtml(game.platform || '')}${game.platform && game.genre ? ' | ' : ''}${escapeHtml(game.genre || '')}
                </div>
              </div>
              ${tagHTML ? `<div class="tags" style="margin-top:4px">${tagHTML}</div>` : ''}
            </div>
            <div style="text-align:right">
              <div class="progress-pill">${Number(game.progress || 0)}%</div>
              <div class="progress-wrap">
                <div class="progress-bar">
                  <div class="progress-fill" style="width:${Number(game.progress || 0)}%"></div>
                </div>
              </div>
              <div style="margin-top:10px">
                <div class="btn-group" style="display:flex;gap:6px">
                  <a href="checklist.html?game_id=${game.game_id}" class="button btn-checklist">Checklist</a>
                  <button type="button" class="button btn-ghost" onclick="editGame(${game.game_id})">Edit</button>
                  <button type="button" class="button btn-delete" onclick="deleteGame(${game.game_id})">Delete</button>
                </div>
              </div>
            </div>
          </div>
        `;
                    container.prepend(div);
                });
            } catch (e) {
                console.error('Load games error:', e);
                toast('Failed to load games.', 'error');
            }
        }

        async function handleSubmit(e) {
            e.preventDefault();

            const title = document.getElementById('title').value.trim();
            const platform = document.getElementById('platform').value;
            const genre = document.getElementById('genre').value;
            const run_type = document.getElementById('run_type').value;
            const tags = document.getElementById('tags').value.trim();

            if (!title || !platform || !genre || !run_type) {
                toast('Please fill in all required fields.', 'error');
                return;
            }

            const payload = { user_id: userId, title, platform, genre, run_type, tags };

            try {
                const res = await fetch(`${API}/api/games`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        Authorization: 'Bearer ' + token
                    },
                    body: JSON.stringify(payload)
                });

                if (res.status === 401) return handleUnauthorized();

                const data = await res.json().catch(() => ({}));

                if (res.ok && data.game_id) {
                    toast('Game added!', 'success');
                    document.getElementById('gameForm').reset();
                    loadGames();
                } else {
                    toast(data.message || 'Failed to add game', 'error');
                }
            } catch (err) {
                console.error('Add game error:', err);
                toast('Network error.', 'error');
            }
        }

        async function deleteGame(id) {
            if (!confirm('Delete this game?')) return;

            try {
                const res = await fetch(`${API}/api/games/${id}`, {
                    method: 'DELETE',
                    headers: { Authorization: 'Bearer ' + token }
                });

                if (res.status === 401) return handleUnauthorized();

                if (res.ok) {
                    toast('Game deleted.', 'info');
                    loadGames();
                } else {
                    toast('Delete failed.', 'error');
                }
            } catch (e) {
                console.error(e);
                toast('Network error.', 'error');
            }
        }

        let editingGameId = null;

        function editGame(id) {
            if (editingGameId) return;
            editingGameId = id;

            const cards = Array.from(document.querySelectorAll('#gameList .card.item'));
            const idx = cards.findIndex(card => card.querySelector(`.btn-checklist[href$="game_id=${id}"]`));
            if (idx === -1) return;

            const card = cards[idx];

            const titleText = card.querySelector("div[style*='font-weight:700']").textContent.trim();
            const [titleOnly, runTypeAfter] = titleText.split(' – ');
            const meta = card.querySelector("div[style*='color:var(--muted)']").textContent || '';
            const [platformCur, genreCur] = meta.split('|').map(s => (s || '').trim());
            const tagsCur = Array.from(card.querySelectorAll('.tag'))
                .map(t => t.textContent.replace(/^#/, '').trim())
                .join(', ');

            const platformSelect = buildSelect('edit_platform', platforms, platformCur);
            const genreSelect = buildSelect('edit_genre', genres, genreCur);
            const runTypeSelect = buildSelect('edit_run_type', runTypes, runTypeAfter || '');

            card.innerHTML = `
      <div style="display:flex;flex-direction:column;gap:10px">
        <div style="display:flex;gap:10px;flex-wrap:wrap">
          <input id="edit_title" class="input" placeholder="Game Title" value="${escapeHtml(titleOnly || '')}" style="flex:2;min-width:240px">
          ${runTypeSelect}
          ${platformSelect}
          ${genreSelect}
          <input id="edit_tags" class="input" placeholder="Tags (comma-separated)" value="${escapeHtml(tagsCur)}" style="flex:2;min-width:240px">
        </div>
        <div style="display:flex;gap:8px;justify-content:flex-end">
          <button type="button" class="button" onclick="saveEdit(${id})">Save</button>
          <button type="button" class="button btn-ghost" onclick="cancelEdit()">Cancel</button>
        </div>
      </div>
    `;
        }

        function buildSelect(id, options, current) {
            const opts = ['<option value="">Select</option>']
                .concat(options.map(o => `<option value="${escapeHtml(o)}"${o === current ? ' selected' : ''}>${escapeHtml(o)}</option>`))
                .join('');
            return `<select id="${id}" class="input" style="flex:1;min-width:160px">${opts}</select>`;
        }

        function escapeHtml(s) {
            return String(s || '')
                .replaceAll('&', '&amp;')
                .replaceAll('<', '&lt;')
                .replaceAll('>', '&gt;')
                .replaceAll('"', '&quot;')
                .replaceAll("'", '&#039;');
        }

        async function saveEdit(id) {
            const title = document.getElementById('edit_title').value.trim();
            const platform = document.getElementById('edit_platform').value.trim();
            const genre = document.getElementById('edit_genre').value.trim();
            const run_type = document.getElementById('edit_run_type').value.trim();
            const tags = document.getElementById('edit_tags').value.trim();

            if (!title) {
                toast('Title is required.', 'error');
                return;
            }

            const payload = {
                title,
                platform: platform || null,
                genre: genre || null,
                run_type: run_type || null,
                tags: tags || null
            };

            try {
                const res = await fetch(`${API}/api/games/${id}`, {
                    method: 'PATCH',
                    headers: {
                        'Content-Type': 'application/json',
                        Authorization: 'Bearer ' + token
                    },
                    body: JSON.stringify(payload)
                });

                if (res.status === 401) return handleUnauthorized();

                const data = await res.json().catch(() => ({}));

                if (res.ok) {
                    toast('Game updated.', 'success');
                    editingGameId = null;
                    loadGames();
                } else {
                    toast(data.message || 'Update failed.', 'error');
                }
            } catch (e) {
                console.error(e);
                toast('Network error.', 'error');
            }
        }

        function cancelEdit() {
            editingGameId = null;
            loadGames();
        }

        function handleUnauthorized() {
            localStorage.removeItem('token');
            try {
                sessionStorage.setItem('redirectAfterLogin', location.pathname + location.search + location.hash);
            } catch { }
            location.replace('/login.html');
        }
    </script>
</body>

</html>