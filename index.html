<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <link rel="icon" href="favicon.ico" type="image/x-icon">
    <link rel="stylesheet" href="styles.css">
    <script src="toast.js" defer></script>
    <title>Dashboard – Completionist Tracker</title>

    <style>
        html {
            visibility: hidden
        }
    </style>
    <script>
        (async () => {
            const LOGIN_PATH = '/login.html';
            const API = 'https://completionist-backend.onrender.com';
            const devAllowLegacy = true;

            const token = localStorage.getItem('token');
            const legacyUserId = localStorage.getItem('ct_user_id');
            const DEFAULT_THUMB = "/images/fallback_thumbnail.png";

            const rememberDest = () => {
                try { sessionStorage.setItem('redirectAfterLogin', location.pathname + location.search + location.hash); } catch { }
            };
            const toLogin = () => { rememberDest(); location.replace(LOGIN_PATH); };

            window.authHeaders = function () {
                const t = localStorage.getItem('token');
                return t ? { Authorization: 'Bearer ' + t } : {};
            };

            if (token) {
                try {
                    const res = await fetch(API + '/api/auth/me', { headers: { Authorization: 'Bearer ' + token } });
                    if (!res.ok) throw new Error('unauthorized');
                    window.currentUser = await res.json().catch(() => null);
                    document.documentElement.style.visibility = 'visible';
                    return;
                } catch {
                    localStorage.removeItem('token');
                }
            }

            if (legacyUserId && devAllowLegacy) {
                window.isLegacySession = true;
                document.documentElement.style.visibility = 'visible';
                return;
            }

            toLogin();
        })();
    </script>
</head>

<body>
    <div class="container">
        <div class="topbar">
            <a href="index.html" class="brand">Completionist Tracker</a>
            <nav class="nav">
                <a class="link-btn btn-ghost" href="index.html">Dashboard</a>
                <a class="link-btn btn-ghost" href="community.html">Community</a>
                <button id="logoutBtn" class="btn-secondary">Log out</button>
            </nav>
        </div>

        <div class="panel wide-panel">
            <h1>My Dashboard</h1>
            <p class="section" style="color: var(--muted)">Track and manage your game progress.</p>

            <form id="gameForm" class="wide-form">
                <div class="form-row"
                    style="flex-direction:row;flex-wrap:wrap;gap:20px;align-items:flex-start;justify-content:space-between">
                    <input id="title" class="input" placeholder="Game Title" required autocomplete="off"
                        style="flex:2;min-width:240px">
                    <select id="run_type" class="input" required style="flex:1;min-width:180px">
                        <option value="">Run Type</option>
                    </select>
                    <select id="platform" class="input" required style="flex:1;min-width:180px">
                        <option value="">Platform</option>
                    </select>
                    <select id="genre" class="input" required style="flex:1;min-width:180px">
                        <option value="">Genre</option>
                    </select>
                    <input id="tags" class="input" placeholder="Tags (comma-separated)" autocomplete="off"
                        style="flex:2;min-width:240px">
                    <input id="thumbnail_url" class="input" placeholder="Thumbnail URL (optional)" autocomplete="off"
                        style="flex:2;min-width:240px">
                    <img id="thumbPreview" alt=""
                        style="width:64px;height:64px;object-fit:cover;border-radius:6px;background:#111;border:1px solid #222;display:none">
                    <div style="display:flex;align-items:center;gap:12px;flex-basis:100%;margin-top:10px">
                        <button class="button" type="submit">Add Game</button>
                        <span id="flash" class="flash"></span>
                    </div>
                </div>
            </form>
        </div>

        <div class="section">
            <ul id="gameList" class="list"></ul>
        </div>
    </div>

    <script>
        const API = 'https://completionist-backend.onrender.com';
        const token = localStorage.getItem('token') || '';
        const userId = Number(localStorage.getItem('ct_user_id') || 0);

        const platforms = [
            'PC', 'PlayStation', 'PlayStation 2', 'PlayStation 3', 'PlayStation 4', 'PlayStation 5',
            'Xbox', 'Xbox 360', 'Xbox One', 'Xbox Series X/S', 'Nintendo Switch', 'Wii', 'Wii U',
            'GameCube', 'Nintendo 64', 'SNES', 'NES', 'Game Boy', 'Game Boy Advance', 'Nintendo DS',
            'Nintendo 3DS', 'PSP', 'PS Vita', 'Mobile', 'Steamdeck', 'Other'
        ];

        const genres = [
            'RPG', 'JRPG', 'Action', 'Adventure', 'Platformer', 'Puzzle', 'Metroidvania',
            'Shooter', 'FPS', 'Fighting', 'Racing', 'Strategy',
            'Real-Time Strategy', 'Turn-Based Strategy', 'Simulation', 'Sports', 'Stealth', 'Survival',
            'Horror', 'Visual Novel', 'Rhythm', 'Sandbox', 'Open World', 'MMORPG', 'Roguelike',
            'Roguelite', 'Card Game', 'Other'
        ];

        const runTypes = [
            'Casual', 'New Game+', 'Any%', '100% Completion', 'Minimalist', 'Low% Run', 'Challenge Run', 'No Damage', 'No Death',
            'Permadeath', 'Speedrun', 'Glitchless', 'Nuzlocke', 'Custom', 'Other'
        ];

        function escapeHtml(s) {
            return String(s || '')
                .replaceAll('&', '&amp;')
                .replaceAll('<', '&lt;')
                .replaceAll('>', '&gt;')
                .replaceAll('"', '&quot;')
                .replaceAll("'", '&#039;');
        }

        function handleUnauthorized() {
            localStorage.removeItem('token');
            try { sessionStorage.setItem('redirectAfterLogin', location.pathname + location.search + location.hash); } catch { }
            location.replace('/login.html');
        }

        function buildSelect(id, options, current) {
            const opts = ['<option value="">Select</option>']
                .concat(options.map(o => `<option value="${escapeHtml(o)}"${o === current ? ' selected' : ''}>${escapeHtml(o)}</option>`))
                .join('');
            return `<select id="${id}" class="input" style="flex:1;min-width:160px">${opts}</select>`;
        }

        window.onload = () => {
            const logoutBtn = document.getElementById('logoutBtn');
            if (logoutBtn) {
                logoutBtn.addEventListener('click', () => {
                    localStorage.removeItem('token');
                    try { sessionStorage.removeItem('redirectAfterLogin'); } catch { }
                    location.replace('/login.html');
                });
            }

            initDropdowns();
            loadGames();
            document.getElementById('gameForm').addEventListener('submit', handleSubmit);

            if (document.documentElement.style.visibility !== 'visible') {
                document.documentElement.style.visibility = 'visible';
            }

            const thumbInput = document.getElementById('thumbnail_url');
            const thumbPreview = document.getElementById('thumbPreview');
            thumbInput.addEventListener('input', () => {
                const url = thumbInput.value.trim();
                if (!url) { thumbPreview.style.display = 'none'; return; }
                thumbPreview.src = url;
                thumbPreview.style.display = 'inline-block';
                thumbPreview.onerror = () => { thumbPreview.onerror = null; thumbPreview.style.display = 'none'; };
            });
        };

        function initDropdowns() {
            fillDropdown('platform', platforms);
            fillDropdown('genre', genres);
            fillDropdown('run_type', runTypes);
        }

        function fillDropdown(id, options) {
            const select = document.getElementById(id);
            options.forEach(opt => {
                const o = document.createElement('option');
                o.value = opt;
                o.textContent = opt;
                select.appendChild(o);
            });
        }

        async function loadGames() {
            try {
                const res = await fetch(`${API}/api/games?user_id=${userId}`, {
                    headers: { Authorization: "Bearer " + token }
                });
                if (res.status === 401) return handleUnauthorized();

                const data = await res.json();
                const container = document.getElementById("gameList");
                container.innerHTML = "";

                if (!Array.isArray(data) || data.length === 0) {
                    container.innerHTML = `<p class="section" style="color:var(--muted)">No games found. Add one above.</p>`;
                    return;
                }

                const games = await Promise.all(
                    data.map(async g => {
                        try {
                            const pr = await fetch(`${API}/api/games/${g.game_id}/progress`, {
                                headers: { Authorization: "Bearer " + token }
                            });
                            if (pr.ok) {
                                const p = await pr.json();
                                return { ...g, progress: Number(p.percent) || 0, _completed: p.completed, _total: p.total };
                            }
                        } catch { }
                        return { ...g, progress: Number(g.progress || 0) || 0 };
                    })
                );

                const fallbackThumb = DEFAULT_THUMB;

                games.sort((a, b) => b.game_id - a.game_id);
                games.forEach((game) => {
                    const div = document.createElement("div");
                    div.className = "card item";

                    // if game progress is 100%, add gold class
                    if (game.progress >= 100) {
                        div.classList.add("gold");
                    }

                    const tagHTML = (game.tags || "")
                        .split(",")
                        .filter(Boolean)
                        .map((tag) => `<span class="tag">#${escapeHtml(tag.trim())}</span>`)
                        .join(" ");

                    const imgSrc = escapeHtml(game.thumbnail_url || game.cover_url || fallbackThumb);
                    const pct = Math.max(0, Math.min(100, Number(game.progress) || 0));

                    div.innerHTML = `
          <div style="display:flex;align-items:stretch;gap:12px;flex-wrap:wrap">
            <img
              src="${imgSrc}"
              alt="${escapeHtml(game.title || "cover")}"
              style="width:96px;height:96px;object-fit:cover;border-radius:8px;background:#111;border:1px solid #222;flex:0 0 auto"
              onerror="this.onerror=null;this.src='${fallbackThumb}'"
            />

            <div style="display:flex;align-items:center;justify-content:space-between;flex:1;gap:10px;flex-wrap:wrap">
              <div>
                <div style="margin-bottom:10px">
                  <div style="font-weight:700;margin-bottom:4px">
                    ${escapeHtml(game.title)}${game.run_type ? ` – ${escapeHtml(game.run_type)}` : ""}
                  </div>
                  <div style="color:var(--muted);font-size:13px">
                    ${escapeHtml(game.platform || "")}${game.platform && game.genre ? " | " : ""}${escapeHtml(game.genre || "")}
                  </div>
                </div>
                ${tagHTML ? `<div class="tags" style="margin-top:4px">${tagHTML}</div>` : ""}
              </div>

              <div style="text-align:right;min-width:220px">
                <div class="progress-pill">${pct}%</div>
                <div class="progress-wrap">
                  <div class="progress-bar">
                    <div class="progress-fill" style="width:${pct}%"></div>
                  </div>
                </div>
                <div style="margin-top:10px">
                  <div class="btn-group" style="display:flex;gap:6px;flex-wrap:wrap;justify-content:flex-end">
                    <a href="checklist.html?game_id=${game.game_id}" class="button btn-checklist">Checklist</a>
                    <button type="button" class="button btn-ghost" onclick="editGame(${game.game_id})">Edit</button>
                    <button type="button" class="button btn-ghost" onclick="setThumbnail(${game.game_id})">Set thumbnail</button>
                    <button type="button" class="button btn-delete" onclick="deleteGame(${game.game_id})">Delete</button>
                  </div>
                </div>
              </div>
            </div>
          </div>`;
                    container.appendChild(div);
                });
            } catch (e) {
                console.error("Load games error:", e);
                toast("Failed to load games.", "error");
            }
        }

        async function handleSubmit(e) {
            e.preventDefault();

            const title = document.getElementById('title').value.trim();
            const platform = document.getElementById('platform').value;
            const genre = document.getElementById('genre').value;
            const run_type = document.getElementById('run_type').value;
            const tags = document.getElementById('tags').value.trim();
            const thumbnail_url_raw = document.getElementById('thumbnail_url').value.trim();

            if (!title || !platform || !genre || !run_type) {
                toast('Please fill in all required fields.', 'error');
                return;
            }

            const payload = { user_id: userId, title, platform, genre, run_type, tags };
            if (thumbnail_url_raw) payload.thumbnail_url = thumbnail_url_raw;

            try {
                const res = await fetch(`${API}/api/games`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', Authorization: 'Bearer ' + token },
                    body: JSON.stringify(payload)
                });

                if (res.status === 401) return handleUnauthorized();

                const data = await res.json().catch(() => ({}));
                if (res.ok && data.game_id) {
                    toast('Game added.', 'success');
                    document.getElementById('gameForm').reset();
                    const thumbPreview = document.getElementById('thumbPreview');
                    thumbPreview.style.display = 'none';
                    loadGames();
                } else {
                    toast(data.message || 'Failed to add game.', 'error');
                }
            } catch (err) {
                console.error('Add game error:', err);
                toast('Network error.', 'error');
            }
        }

        async function deleteGame(id) {
            if (!confirm('Delete this game?')) return;

            try {
                const res = await fetch(`${API}/api/games/${id}`, {
                    method: 'DELETE',
                    headers: { Authorization: 'Bearer ' + token }
                });

                if (res.status === 401) return handleUnauthorized();

                if (res.ok) {
                    toast('Game deleted.', 'info');
                    loadGames();
                } else {
                    toast('Delete failed.', 'error');
                }
            } catch (e) {
                console.error(e);
                toast('Network error.', 'error');
            }
        }

        let editingGameId = null;

        function editGame(id) {
            if (editingGameId) return;
            editingGameId = id;

            const cards = Array.from(document.querySelectorAll('#gameList .card.item'));
            const idx = cards.findIndex(card => card.querySelector(`.btn-checklist[href$="game_id=${id}"]`));
            if (idx === -1) return;

            const card = cards[idx];

            const titleText = card.querySelector("div[style*='font-weight:700']").textContent.trim();
            const [titleOnly, runTypeAfter] = titleText.split(' – ');
            const meta = card.querySelector("div[style*='color:var(--muted)']").textContent || '';
            const [platformCur, genreCur] = meta.split('|').map(s => (s || '').trim());
            const tagsCur = Array.from(card.querySelectorAll('.tag')).map(t => t.textContent.replace(/^#/, '').trim()).join(', ');

            const imgEl = card.querySelector('img');
            const currentThumb = imgEl ? imgEl.getAttribute('src') || '' : '';

            const platformSelect = buildSelect('edit_platform', platforms, platformCur);
            const genreSelect = buildSelect('edit_genre', genres, genreCur);
            const runTypeSelect = buildSelect('edit_run_type', runTypes, runTypeAfter || '');

            card.innerHTML = `
      <div style="display:flex;flex-direction:column;gap:10px">
        <div style="display:flex;gap:10px;flex-wrap:wrap;align-items:flex-start">
          <img id="edit_thumb_preview_${id}" alt=""
               style="width:96px;height:96px;object-fit:cover;border-radius:8px;background:#111;border:1px solid #222;${currentThumb ? '' : 'display:none'}"
               ${currentThumb ? `src="${escapeHtml(currentThumb)}"` : ''}>
        </div>

        <div style="display:flex;gap:10px;flex-wrap:wrap">
          <input id="edit_title" class="input" placeholder="Game Title" value="${escapeHtml(titleOnly || '')}" style="flex:2;min-width:240px">
          ${runTypeSelect}
          ${platformSelect}
          ${genreSelect}
          <input id="edit_tags" class="input" placeholder="Tags (comma-separated)" value="${escapeHtml(tagsCur)}" style="flex:2;min-width:240px">
          <input id="edit_thumbnail_url" class="input" placeholder="Thumbnail URL (optional)" value="${escapeHtml(currentThumb || '')}" style="flex:2;min-width:240px">
        </div>

        <div style="display:flex;gap:8px;justify-content:flex-end">
          <button type="button" class="button" onclick="saveEdit(${id})">Save</button>
          <button type="button" class="button btn-ghost" onclick="cancelEdit()">Cancel</button>
        </div>
      </div>
    `;

            const thumbInput = document.getElementById('edit_thumbnail_url');
            const preview = document.getElementById(`edit_thumb_preview_${id}`);
            if (thumbInput && preview) {
                thumbInput.addEventListener('input', () => {
                    const url = thumbInput.value.trim();
                    if (!url) { preview.style.display = 'none'; preview.removeAttribute('src'); return; }
                    preview.style.display = 'block';
                    preview.src = url;
                    preview.onerror = () => { preview.onerror = null; preview.style.display = 'none'; };
                });
            }
        }

        window.saveEdit = async function (id) {
            const title = document.getElementById('edit_title').value.trim();
            const platform = document.getElementById('edit_platform').value.trim();
            const genre = document.getElementById('edit_genre').value.trim();
            const run_type = document.getElementById('edit_run_type').value.trim();
            const tags = document.getElementById('edit_tags').value.trim();
            const thumbEl = document.getElementById('edit_thumbnail_url');
            const thumb = thumbEl ? thumbEl.value.trim() : '';

            if (!title) { toast('Title is required.', 'error'); return; }

            const payload = {
                title,
                platform: platform || null,
                genre: genre || null,
                run_type: run_type || null,
                tags: tags || null,
                thumbnail_url: thumb || null
            };

            try {
                const res = await fetch(`${API}/api/games/${id}`, {
                    method: 'PATCH',
                    headers: { 'Content-Type': 'application/json', Authorization: 'Bearer ' + token },
                    body: JSON.stringify(payload)
                });

                if (res.status === 401) return handleUnauthorized();

                const data = await res.json().catch(() => ({}));
                if (res.ok) {
                    toast('Game updated.', 'success');
                    editingGameId = null;
                    loadGames();
                } else {
                    toast(data.message || 'Update failed.', 'error');
                }
            } catch (e) {
                console.error(e);
                toast('Network error.', 'error');
            }
        };

        window.cancelEdit = function () {
            editingGameId = null;
            loadGames();
        };

        window.setThumbnail = async function (id) {
            const url = prompt("Paste an image URL for this game’s thumbnail:");
            if (url === null) return;
            const clean = String(url).trim();
            if (!clean) { toast("No URL provided.", "error"); return; }

            try {
                const res = await fetch(`${API}/api/games/${id}/thumbnail`, {
                    method: "PATCH",
                    headers: { "Content-Type": "application/json", Authorization: "Bearer " + token },
                    body: JSON.stringify({ thumbnail_url: clean })
                });
                const data = await res.json().catch(() => ({}));
                if (res.ok) {
                    toast("Thumbnail updated.", "success");
                    loadGames();
                } else {
                    toast(data.message || "Failed to update thumbnail.", "error");
                }
            } catch (e) {
                console.error(e);
                toast("Network error.", "error");
            }
        };
    </script>
</body>

</html>