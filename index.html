<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <link rel="stylesheet" href="styles.css">
    <script src="toast.js" defer></script>
    <title>Dashboard â€“ Completionist Tracker</title>
</head>

<body>
    <div class="container">
        <div class="topbar">
            <div class="brand">Completionist Tracker</div>
            <div class="nav">
                <a class="link-btn btn-ghost" href="community.html">Community</a>
                <button id="logoutBtn" class="btn-secondary">Log out</button>
            </div>
        </div>

        <div class="panel">
            <h1>My Dashboard</h1>
            <div class="section">
                <div class="form-row">
                    <input id="title" class="input" placeholder="Title">
                    <input id="platform" class="input" placeholder="Platform">
                    <input id="genre" class="input" placeholder="Genre">
                    <button id="addBtn" class="button">Add game</button>
                    <span id="flash" class="flash"></span>
                </div>
            </div>
        </div>

        <div class="section">
            <ul id="games" class="list"></ul>
        </div>
    </div>

    <script>
        const API = "https://completionist-backend.onrender.com";

        const userId = Number(localStorage.getItem("ct_user_id") || 0);

        if (!userId) window.location.href = "login.html";

        document.getElementById("logoutBtn").onclick = () => {
            localStorage.removeItem("ct_user_id");
            localStorage.removeItem("ct_email");
            localStorage.removeItem("ct_token");
            window.location.href = "login.html";
        };

        async function loadGames() {
            const res = await fetch(`${API}/api/games?user_id=${userId}`);
            const list = await res.json();
            const ul = document.getElementById("games");
            ul.innerHTML = "";

            if (!Array.isArray(list) || list.length === 0) {
                ul.innerHTML = `<li class="card item"><span style="color:var(--muted)">No games yet. Add one above.</span></li>`;
                return;
            }

            for (const g of list) {
                let percent = 0;
                try {
                    const pr = await fetch(`${API}/api/games/${g.game_id}/progress`);
                    const pj = await pr.json();
                    percent = pj.percent ?? 0;
                } catch { }

                const li = document.createElement("li");
                li.className = "card item";
                li.innerHTML = `
              <div style="display:flex;align-items:center;justify-content:space-between;gap:10px;flex-wrap:wrap">
                <div>
                  <div style="font-weight:700">${g.title}</div>
                  <div style="color:var(--muted);font-size:13px">${g.platform || ""} ${g.genre || ""}</div>
                </div>
                <div class="progress">${percent}% complete</div>
              </div>
              <div style="display:flex;gap:8px;margin-top:10px;flex-wrap:wrap">
                <button data-open="${g.game_id}" class="button">Checklist</button>
                <button data-edit="${g.game_id}" class="btn-secondary">Edit</button>
                <button data-del="${g.game_id}" class="btn-ghost">Delete</button>
              </div>
            `;
                ul.appendChild(li);
            }

            ul.onclick = async (e) => {
                const openId = e.target.getAttribute("data-open");
                const delId = e.target.getAttribute("data-del");
                const editId = e.target.getAttribute("data-edit");

                if (openId) {
                    window.location.href = `checklist.html?game_id=${openId}`;
                    return;
                }

                if (delId) {
                    if (!confirm("Delete this game?")) return;
                    const res = await fetch(`${API}/api/games/${delId}`, { method: "DELETE" });
                    if (res.ok) loadGames();
                    else toast("Delete failed", "error");
                    return;
                }

                if (editId) {
                    let current = { title: "", platform: "", genre: "" };
                    try {
                        const curRes = await fetch(`${API}/api/games/${editId}`);
                        if (curRes.ok) current = await curRes.json();
                    } catch { }

                    const newTitle = prompt("New title (leave blank to keep current):", current.title || "");
                    if (newTitle === null) return;

                    const newPlatform = prompt("New platform (blank to clear, leave as is to keep):", current.platform || "");
                    if (newPlatform === null) return;

                    const newGenre = prompt("New genre (blank to clear, leave as is to keep):", current.genre || "");
                    if (newGenre === null) return;

                    const payload = {};
                    if (newTitle.trim() !== "") payload.title = newTitle.trim();
                    payload.platform = (newPlatform || "").trim();
                    payload.genre = (newGenre || "").trim();

                    const res = await fetch(`${API}/api/games/${editId}`, {
                        method: "PATCH",
                        headers: { "Content-Type": "application/json" },
                        body: JSON.stringify(payload)
                    });

                    if (!res.ok) {
                        const data = await res.json().catch(() => ({}));
                        toast(data.message || "Update failed", "error");
                        return;
                    }
                    loadGames();
                }
            };
        }

        async function addGame() {
            const payload = {
                user_id: userId,
                title: document.getElementById("title").value.trim(),
                platform: document.getElementById("platform").value.trim(),
                genre: document.getElementById("genre").value.trim()
            };
            if (!payload.title) {
                toast("Title is required", "error");
                return;
            }
            const res = await fetch(`${API}/api/games`, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify(payload)
            });
            const flash = document.getElementById("flash");
            if (res.ok) {
                flash.textContent = "";
                toast("Game added", "success");
                document.getElementById("title").value = "";
                loadGames();
            } else {
                const data = await res.json().catch(() => ({}));
                toast(data.message || "Add failed", "error");
            }
        }

        document.getElementById("addBtn").addEventListener("click", addGame);
        loadGames();
    </script>
</body>

</html>