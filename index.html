<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <link rel="stylesheet" href="styles.css">
    <script src="toast.js" defer></script>
    <title>Dashboard – Completionist Tracker</title>
</head>

<body>
    <div class="container">
        <div class="topbar">
            <div class="brand">Completionist Tracker</div>
            <nav class="nav">
                <a class="link-btn btn-ghost" href="index.html">Dashboard</a>
                <a class="link-btn btn-ghost" href="community.html">Community</a>
                <button id="logoutBtn" class="btn-secondary">Log out</button>
            </nav>
        </div>

        <div class="panel wide-panel">
            <h1>My Dashboard</h1>
            <p class="section" style="color: var(--muted)">Track and manage your game progress.</p>

            <form id="gameForm" class="wide-form">
                <div class="form-row"
                    style="flex-direction: row; flex-wrap: wrap; gap: 20px; align-items: flex-start; justify-content: space-between">
                    <input id="title" class="input" placeholder="Game Title" required autocomplete="off"
                        style="flex: 2; min-width: 240px">
                    <select id="run_type" class="input" required style="flex: 1; min-width: 160px">
                        <option value="">Run Type</option>
                    </select>
                    <select id="platform" class="input" required style="flex: 1; min-width: 160px">
                        <option value="">Platform</option>
                    </select>
                    <select id="genre" class="input" required style="flex: 1; min-width: 160px">
                        <option value="">Genre</option>
                    </select>
                    <input id="tags" class="input" placeholder="Tags (comma-separated)" autocomplete="off"
                        style="flex: 2; min-width: 240px">
                    <div style="display: flex; align-items: center; gap: 12px; flex-basis: 100%; margin-top: 10px">
                        <button class="button" type="submit">Add Game</button>
                        <span id="flash" class="flash"></span>
                    </div>
                </div>
            </form>
        </div>

        <div class="section">
            <ul id="gameList" class="list"></ul>
        </div>
    </div>

    <script>
        const API = "https://completionist-backend.onrender.com";
        const userId = Number(localStorage.getItem("ct_user_id") || 0);

        const platforms = [
            "PC",
            "PlayStation",
            "PlayStation 2",
            "PlayStation 3",
            "PlayStation 4",
            "PlayStation 5",
            "Xbox",
            "Xbox 360",
            "Xbox One",
            "Xbox Series X/S",
            "Nintendo Switch",
            "Wii",
            "Wii U",
            "GameCube",
            "Nintendo 64",
            "SNES",
            "NES",
            "Game Boy",
            "Game Boy Advance",
            "Nintendo DS",
            "Nintendo 3DS",
            "PSP",
            "PS Vita",
            "Mobile",
            "Other"
        ];

        const genres = [
            "RPG",
            "JRPG",
            "Action",
            "Adventure",
            "Action-Adventure",
            "Platformer",
            "Puzzle",
            "Metroidvania",
            "Shooter",
            "First-Person Shooter",
            "Third-Person Shooter",
            "Fighting",
            "Racing",
            "Strategy",
            "Real-Time Strategy",
            "Turn-Based Strategy",
            "Simulation",
            "Sports",
            "Stealth",
            "Survival",
            "Survival Horror",
            "Visual Novel",
            "Rhythm",
            "Sandbox",
            "Open World",
            "MMORPG",
            "Roguelike",
            "Roguelite",
            "Card Game",
            "Other"
        ];

        const runTypes = [
            "100% Completion",
            "Any%",
            "Minimalist",
            "Low% Run",
            "Challenge Run",
            "No Damage",
            "No Death",
            "Permadeath / Ironman",
            "Speedrun",
            "Glitchless",
            "Casual",
            "New Game+",
            "Custom"
        ];

        window.onload = () => {
            initDropdowns();
            loadGames();
            document.getElementById("gameForm").addEventListener("submit", handleSubmit);
        };

        function initDropdowns() {
            fillDropdown("platform", platforms);
            fillDropdown("genre", genres);
            fillDropdown("run_type", runTypes);
        }

        function fillDropdown(id, options) {
            const select = document.getElementById(id);
            options.forEach(opt => {
                const o = document.createElement("option");
                o.value = opt;
                o.textContent = opt;
                select.appendChild(o);
            });
        }

        async function loadGames() {
            const res = await fetch(`${API}/api/games?user_id=${userId}`);
            const data = await res.json();

            const container = document.getElementById("gameList");
            container.innerHTML = "";

            if (!Array.isArray(data) || data.length === 0) {
                container.innerHTML = `<p class="section" style="color:var(--muted)">No games found. Add one above.</p>`;
                return;
            }

            data.forEach(game => {
                const div = document.createElement("div");
                div.className = "card item";

                const tagHTML = (game.tags || "")
                    .split(",")
                    .map(tag => `<span class="tag">#${tag.trim()}</span>`)
                    .join(" ");

                div.innerHTML = `
          <div style="display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap;gap:10px">
            <div>
                <div style="font-weight:700">
                ${game.title}${game.run_type ? ` – ${game.run_type}` : ""}
                </div>
                <div style="color:var(--muted);font-size:13px">
                ${game.platform || ""}${game.platform && game.genre ? " | " : ""}${game.genre || ""}
                </div>
                ${tagHTML ? `<div class="tags" style="margin-top:4px">${tagHTML}</div>` : ""}
            </div>
            <div style="text-align:right">
            <div class="progress" style="font-size:16px; font-weight:600">
                ${game.progress || 0}%
            </div>
            <div style="margin-top:10px">
                <div class="btn-group" style="display:flex; gap:6px">
                <a href="checklist.html?game_id=${game.game_id}" class="button btn-checklist">Checklist</a>
                <button type="button" class="button btn-ghost" onclick="editGame(${game.game_id})">Edit</button>
                <button type="button" class="button btn-delete" onclick="deleteGame(${game.game_id})">Delete</button>
                </div>
            </div>
            </div>
          </div>
        `;
                container.appendChild(div);
            });
        }

        async function handleSubmit(e) {
            e.preventDefault();

            const title = document.getElementById("title").value.trim();
            const platform = document.getElementById("platform").value;
            const genre = document.getElementById("genre").value;
            const run_type = document.getElementById("run_type").value;
            const tags = document.getElementById("tags").value.trim();

            // Validate
            if (!title || !platform || !genre || !run_type) {
                toast("Please fill in all required fields.", "error");
                return;
            }

            const payload = {
                user_id: userId,
                title,
                platform,
                genre,
                run_type,
                tags
            };

            console.log("Submitting:", payload); // Debug log

            try {
                const res = await fetch(`${API}/api/games`, {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify(payload)
                });

                const data = await res.json().catch(() => ({}));

                if (res.ok && data.game_id) {
                    toast("Game added!", "success");
                    document.getElementById("gameForm").reset();
                    loadGames();
                } else {
                    toast(data.message || "Failed to add game", "error");
                }
            } catch (err) {
                console.error("Add game error:", err);
                toast("Network error.", "error");
            }
        }


        async function deleteGame(id) {
            if (!confirm("Delete this game?")) return;

            const res = await fetch(`${API}/api/games/${id}`, { method: "DELETE" });
            if (res.ok) {
                toast("Game deleted.", "info");
                loadGames();
            }
        }

        let editingGameId = null;

        function editGame(id) {
            if (editingGameId) return; // prevent multiple rows in edit mode
            editingGameId = id;

            // find the card DOM for this game
            const cards = Array.from(document.querySelectorAll("#gameList .card.item"));
            const idx = cards.findIndex(card =>
                card.querySelector(`.btn-checklist[href$="game_id=${id}"]`)
            );
            if (idx === -1) return;

            const card = cards[idx];

            // read current values from the card (fallbacks if empty)
            const titleText = card.querySelector("div[style*='font-weight:700']").textContent.trim();
            // titleText may be "Title – Run Type"
            const [titleOnly, runTypeAfter] = titleText.split(" – ");
            const meta = card.querySelector("div[style*='color:var(--muted)']").textContent || "";
            const [platformCur, genreCur] = meta.split("|").map(s => (s || "").trim());
            const tagsCur = Array.from(card.querySelectorAll(".tag"))
                .map(t => t.textContent.replace(/^#/, "").trim())
                .join(", ");

            const rtCur = runTypeAfter || "";

            // build selects with current values selected
            const platformSelect = buildSelect("edit_platform", platforms, platformCur);
            const genreSelect = buildSelect("edit_genre", genres, genreCur);
            const runTypeSelect = buildSelect("edit_run_type", runTypes, rtCur);

            card.innerHTML = `
    <div style="display:flex;flex-direction:column;gap:10px">
      <div style="display:flex;gap:10px;flex-wrap:wrap">
        <input id="edit_title" class="input" placeholder="Game Title" value="${escapeHtml(titleOnly || "")}" style="flex:2;min-width:240px">
        ${runTypeSelect}
        ${platformSelect}
        ${genreSelect}
        <input id="edit_tags" class="input" placeholder="Tags (comma-separated)" value="${escapeHtml(tagsCur)}" style="flex:2;min-width:240px">
      </div>
      <div style="display:flex;gap:8px;justify-content:flex-end">
        <button type="button" class="button" onclick="saveEdit(${id})">Save</button>
        <button type="button" class="button btn-ghost" onclick="cancelEdit()">Cancel</button>
      </div>
    </div>
  `;
        }

        function buildSelect(id, options, current) {
            const opts = ['<option value="">Select</option>']
                .concat(options.map(o => `<option value="${escapeHtml(o)}"${o === current ? " selected" : ""}>${escapeHtml(o)}</option>`))
                .join("");
            return `<select id="${id}" class="input" style="flex:1;min-width:160px">${opts}</select>`;
        }

        function escapeHtml(s) {
            return String(s || "")
                .replaceAll("&", "&amp;")
                .replaceAll("<", "&lt;")
                .replaceAll(">", "&gt;")
                .replaceAll('"', "&quot;")
                .replaceAll("'", "&#039;");
        }

        async function saveEdit(id) {
            const title = document.getElementById("edit_title").value.trim();
            const platform = document.getElementById("edit_platform").value.trim();
            const genre = document.getElementById("edit_genre").value.trim();
            const run_type = document.getElementById("edit_run_type").value.trim();
            const tags = document.getElementById("edit_tags").value.trim();

            if (!title) {
                toast("Title is required.", "error");
                return;
            }

            const payload = {
                title,
                platform: platform || null,
                genre: genre || null,
                run_type: run_type || null,
                tags: tags || null
            };

            try {
                const res = await fetch(`${API}/api/games/${id}`, {
                    method: "PATCH",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify(payload)
                });
                const data = await res.json().catch(() => ({}));

                if (res.ok) {
                    toast("Game updated.", "success");
                    editingGameId = null;
                    loadGames();
                } else {
                    toast(data.message || "Update failed.", "error");
                }
            } catch (e) {
                console.error(e);
                toast("Network error.", "error");
            }
        }

        function cancelEdit() {
            editingGameId = null;
            loadGames(); // re-render original card
        }
    </script>

</body>

</html>