<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <link rel="stylesheet" href="styles.css">
    <script src="toast.js" defer></script>
    <title>Dashboard â€“ Completionist Tracker</title>
</head>

<body>
    <div class="container">
        <div class="topbar">
            <div class="brand">Completionist Tracker</div>
            <div class="nav">
                <a class="link-btn btn-ghost" href="community.html">Community</a>
                <button id="logoutBtn" class="btn-secondary">Log out</button>
            </div>
        </div>

        <div class="panel" style="max-width: 700px; margin: 0 auto">
            <h1>My Dashboard</h1>
            <p class="section" style="color: var(--muted)">Track and manage your game progress.</p>

            <form id="gameForm">
                <div class="form-row" style="flex-direction: column; gap: 14px">
                    <input id="title" class="input" placeholder="Game Title" required autocomplete="off">

                    <div style="display: flex; flex-wrap: wrap; gap: 10px">
                        <select id="run_type" class="input" required style="flex: 1; min-width: 160px">
                            <option value="">Run Type</option>
                        </select>
                        <select id="platform" class="input" required style="flex: 1; min-width: 160px">
                            <option value="">Platform</option>
                        </select>
                        <select id="genre" class="input" required style="flex: 1; min-width: 160px">
                            <option value="">Genre</option>
                        </select>
                    </div>

                    <input id="tags" class="input" placeholder="Tags (comma-separated)" autocomplete="off">

                    <div style="display: flex; align-items: center; gap: 12px">
                        <button class="button" type="submit">Add Game</button>
                        <span id="flash" class="flash"></span>
                    </div>
                </div>
            </form>
        </div>

        <div class="section">
            <ul id="gameList" class="list"></ul>
        </div>
    </div>

    <script>
        const API = "https://completionist-backend.onrender.com";
        const userId = Number(localStorage.getItem("ct_user_id") || 0);

        const platforms = ["PC", "PlayStation", "Xbox", "Switch", "Mobile"];
        const genres = ["RPG", "Action", "Adventure", "Platformer", "Puzzle"];
        const runTypes = ["100% Completion", "Minimalist", "Challenge Run", "Speedrun", "Custom"];

        window.onload = () => {
            initDropdowns();
            loadGames();
            document.getElementById("gameForm").addEventListener("submit", handleSubmit);
        };

        function initDropdowns() {
            fillDropdown("platform", platforms);
            fillDropdown("genre", genres);
            fillDropdown("run_type", runTypes);
        }

        function fillDropdown(id, options) {
            const select = document.getElementById(id);
            options.forEach(opt => {
                const o = document.createElement("option");
                o.value = opt;
                o.textContent = opt;
                select.appendChild(o);
            });
        }

        async function loadGames() {
            const res = await fetch(`${API}/api/games/${userId}`);
            const data = await res.json();

            const container = document.getElementById("gameList");
            container.innerHTML = "";

            if (!Array.isArray(data) || data.length === 0) {
                container.innerHTML = `<p class="section" style="color:var(--muted)">No games found. Add one above.</p>`;
                return;
            }

            data.forEach(game => {
                const div = document.createElement("div");
                div.className = "card item";

                const tagHTML = (game.tags || "")
                    .split(",")
                    .map(tag => `<span class="tag">#${tag.trim()}</span>`)
                    .join(" ");

                div.innerHTML = `
          <div style="display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap;gap:10px">
            <div>
              <div style="font-weight:700">${game.title}</div>
              <div style="color:var(--muted);font-size:13px">
                ${game.platform || ""}${game.platform && game.genre ? " | " : ""}${game.genre || ""}
              </div>
              <div style="color:var(--muted);font-size:13px">${game.run_type || ""}</div>
              <div class="tags" style="margin-top:4px">${tagHTML}</div>
            </div>
            <div style="text-align:right">
              <div class="progress" style="font-size:16px;font-weight:600">${game.progress || 0}%</div>
              <div style="margin-top:10px">
                <a href="checklist.html?game_id=${game.game_id}" class="button btn-secondary">Checklist</a>
                <button class="button btn-ghost" onclick="editGame(${game.game_id})">Edit</button>
                <button class="button btn-ghost" onclick="deleteGame(${game.game_id})">Delete</button>
              </div>
            </div>
          </div>
        `;
                container.appendChild(div);
            });
        }

        async function handleSubmit(e) {
            e.preventDefault();

            const title = document.getElementById("title").value.trim();
            const platform = document.getElementById("platform").value;
            const genre = document.getElementById("genre").value;
            const run_type = document.getElementById("run_type").value;
            const tags = document.getElementById("tags").value.trim();

            if (!title || !platform || !genre) {
                toast("Please fill in all required fields.", "error");
                return;
            }

            const res = await fetch(`${API}/api/games`, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ user_id: userId, title, platform, genre, run_type, tags })
            });

            if (res.ok) {
                toast("Game added!", "success");
                document.getElementById("gameForm").reset();
                loadGames();
            } else {
                toast("Failed to add game", "error");
            }
        }

        async function deleteGame(id) {
            if (!confirm("Delete this game?")) return;

            const res = await fetch(`${API}/api/games/${id}`, { method: "DELETE" });
            if (res.ok) {
                toast("Game deleted.", "info");
                loadGames();
            }
        }

        function editGame(id) {
            window.location.href = `checklist.html?game_id=${id}`;
        }
    </script>

</body>

</html>