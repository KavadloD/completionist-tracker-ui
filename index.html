<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <link rel="stylesheet" href="styles.css">
    <script src="toast.js" defer></script>
    <title>Dashboard – Completionist Tracker</title>
</head>

<body>
    <div class="container">
        <div class="topbar">
            <div class="brand">Completionist Tracker</div>
            <nav class="nav">
                <a class="link-btn btn-ghost" href="index.html">Dashboard</a>
                <a class="link-btn btn-ghost" href="community.html">Community</a>
                <button id="logoutBtn" class="btn-secondary">Log out</button>
            </nav>
        </div>

        <div class="panel wide-panel">
            <h1>My Dashboard</h1>
            <p class="section" style="color: var(--muted)">Track and manage your game progress.</p>

            <form id="gameForm" class="wide-form">
                <div class="form-row"
                    style="flex-direction: row; flex-wrap: wrap; gap: 20px; align-items: flex-start; justify-content: space-between">
                    <input id="title" class="input" placeholder="Game Title" required autocomplete="off"
                        style="flex: 2; min-width: 240px">
                    <select id="run_type" class="input" required style="flex: 1; min-width: 160px">
                        <option value="">Run Type</option>
                    </select>
                    <select id="platform" class="input" required style="flex: 1; min-width: 160px">
                        <option value="">Platform</option>
                    </select>
                    <select id="genre" class="input" required style="flex: 1; min-width: 160px">
                        <option value="">Genre</option>
                    </select>
                    <input id="tags" class="input" placeholder="Tags (comma-separated)" autocomplete="off"
                        style="flex: 2; min-width: 240px">
                    <div style="display: flex; align-items: center; gap: 12px; flex-basis: 100%; margin-top: 10px">
                        <button class="button" type="submit">Add Game</button>
                        <span id="flash" class="flash"></span>
                    </div>
                </div>
            </form>
        </div>

        <div class="section">
            <ul id="gameList" class="list"></ul>
        </div>
    </div>

    <script>
        const API = "https://completionist-backend.onrender.com";
        const userId = Number(localStorage.getItem("ct_user_id") || 0);

        const platforms = ["PC", "PlayStation", "Xbox", "Switch", "Mobile"];
        const genres = ["RPG", "Action", "Adventure", "Platformer", "Puzzle"];
        const runTypes = ["100% Completion", "Minimalist", "Challenge Run", "Speedrun", "Custom"];

        window.onload = () => {
            initDropdowns();
            loadGames();
            document.getElementById("gameForm").addEventListener("submit", handleSubmit);
        };

        function initDropdowns() {
            fillDropdown("platform", platforms);
            fillDropdown("genre", genres);
            fillDropdown("run_type", runTypes);
        }

        function fillDropdown(id, options) {
            const select = document.getElementById(id);
            options.forEach(opt => {
                const o = document.createElement("option");
                o.value = opt;
                o.textContent = opt;
                select.appendChild(o);
            });
        }

        async function loadGames() {
            const res = await fetch(`${API}/api/games?user_id=${userId}`);
            const data = await res.json();

            const container = document.getElementById("gameList");
            container.innerHTML = "";

            if (!Array.isArray(data) || data.length === 0) {
                container.innerHTML = `<p class="section" style="color:var(--muted)">No games found. Add one above.</p>`;
                return;
            }

            data.forEach(game => {
                const div = document.createElement("div");
                div.className = "card item";

                const tagHTML = (game.tags || "")
                    .split(",")
                    .map(tag => `<span class="tag">#${tag.trim()}</span>`)
                    .join(" ");

                div.innerHTML = `
          <div style="display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap;gap:10px">
            <div>
                <div style="font-weight:700">
                ${game.title}${game.run_type ? ` – ${game.run_type}` : ""}
                </div>
                <div style="color:var(--muted);font-size:13px">
                ${game.platform || ""}${game.platform && game.genre ? " | " : ""}${game.genre || ""}
                </div>
                ${tagHTML ? `<div class="tags" style="margin-top:4px">${tagHTML}</div>` : ""}
            </div>
            <div style="text-align:right">
            <div class="progress" style="font-size:16px; font-weight:600">
                ${game.progress || 0}%
            </div>
            <div style="margin-top:10px">
                <div class="btn-group" style="display:flex; gap:6px">
                <a href="checklist.html?game_id=${game.game_id}" class="button btn-checklist">Checklist</a>
                <button type="button" class="button btn-ghost" onclick="editGame(${game.game_id})">Edit</button>
                <button type="button" class="button btn-delete" onclick="deleteGame(${game.game_id})">Delete</button>
                </div>
            </div>
            </div>
          </div>
        `;
                container.appendChild(div);
            });
        }

        async function handleSubmit(e) {
            e.preventDefault();

            const title = document.getElementById("title").value.trim();
            const platform = document.getElementById("platform").value;
            const genre = document.getElementById("genre").value;
            const run_type = document.getElementById("run_type").value;
            const tags = document.getElementById("tags").value.trim();

            // Validate
            if (!title || !platform || !genre || !run_type) {
                toast("Please fill in all required fields.", "error");
                return;
            }

            const payload = {
                user_id: userId,
                title,
                platform,
                genre,
                run_type,
                tags
            };

            console.log("Submitting:", payload); // Debug log

            try {
                const res = await fetch(`${API}/api/games`, {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify(payload)
                });

                const data = await res.json().catch(() => ({}));

                if (res.ok && data.game_id) {
                    toast("Game added!", "success");
                    document.getElementById("gameForm").reset();
                    loadGames();
                } else {
                    toast(data.message || "Failed to add game", "error");
                }
            } catch (err) {
                console.error("Add game error:", err);
                toast("Network error.", "error");
            }
        }


        async function deleteGame(id) {
            if (!confirm("Delete this game?")) return;

            const res = await fetch(`${API}/api/games/${id}`, { method: "DELETE" });
            if (res.ok) {
                toast("Game deleted.", "info");
                loadGames();
            }
        }

        function editGame(id) {
            window.location.href = `checklist.html?game_id=${id}`;
        }
    </script>

</body>

</html>