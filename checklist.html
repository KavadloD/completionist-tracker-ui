<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <link rel="stylesheet" href="styles.css">
    <script src="toast.js" defer></script>
    <link rel="icon" href="favicon.ico" type="image/x-icon">
    <title>Checklist – Completionist Tracker</title>

    <style>
        html {
            visibility: hidden
        }
    </style>
    <script>
        (async () => {
            const LOGIN_PATH = '/login.html';
            const token = localStorage.getItem('token');
            const legacyUserId = localStorage.getItem('ct_user_id');

            const rememberDest = () => {
                try {
                    sessionStorage.setItem('redirectAfterLogin', location.pathname + location.search + location.hash);
                } catch { }
            };

            const toLogin = () => {
                rememberDest();
                location.replace(LOGIN_PATH);
            };

            if (token) {
                try {
                    const res = await fetch("https://completionist-backend.onrender.com/api/auth/me", {
                        headers: { Authorization: "Bearer " + token }
                    });
                    if (!res.ok) throw new Error("unauthorized");
                    document.documentElement.style.visibility = "visible";
                    return;
                } catch {
                    localStorage.removeItem("token");
                }
            }

            if (legacyUserId) {
                console.warn("Running in legacy mode (no token)");
                document.documentElement.style.visibility = "visible";
                return;
            }

            toLogin();
        })();
    </script>

</head>

<body>
    <div class="container">
        <div class="topbar">
            <a href="index.html" class="brand">Completionist Tracker</a>
            <nav class="nav">
                <a class="link-btn btn-ghost" href="index.html">Dashboard</a>
                <a class="link-btn btn-ghost" href="community.html">Community</a>
                <button id="logoutBtn" class="btn-secondary">Log out</button>
            </nav>
        </div>

        <!-- Top panel: title + subtitle + controls on the left, thumbnail on the right -->
        <div class="panel" style="margin-top:12px">
            <div style="display:flex; gap:16px; align-items:flex-start; justify-content:space-between;">
                <!-- Left: title, subtitle, progress, add-item -->
                <div style="flex:1 1 auto; min-width:260px;">
                    <h1 id="gameTitle" style="margin:0 0 6px 0">Game Checklist</h1>
                    <p class="section" style="color: var(--muted); margin:0 0 12px 0">
                        Track your progress for individual game goals.
                    </p>

                    <div>
                        <div id="progressText" class="progress-pill" style="display:inline-block">Progress: …</div>
                        <div style="display:flex; gap:8px; align-items:center; margin-top:10px;">
                            <input id="descriptionInput" class="input" placeholder="New checklist item"
                                style="flex:1 1 260px; min-width:220px;">
                            <button id="addBtn" class="button">Add</button>
                        </div>
                    </div>
                </div>

                <!-- Right: square thumbnail -->
                <img id="gameThumb" alt=""
                    style="width:160px;height:160px;object-fit:cover;border-radius:12px;background:#111;border:1px solid #222;display:none">
            </div>
        </div>


        <!-- Items list -->
        <div class="panel wide-panel" style="margin-top:16px;">
            <ul id="items" class="list"></ul>
        </div>

    </div>

    <script>
        const API = "https://completionist-backend.onrender.com";
        const token = localStorage.getItem("token") || "";
        const userId = Number(localStorage.getItem("ct_user_id") || 0);
        const params = new URLSearchParams(window.location.search);
        const GAME_ID = Number(params.get("game_id") || 0);

        if (!GAME_ID) {
            toast("Missing game ID, returning to dashboard", "error");
            window.location.href = "index.html";
        }

        const itemsEl = document.getElementById("items");
        const inputEl = document.getElementById("descriptionInput");
        const addBtn = document.getElementById("addBtn");
        const progressEl = document.getElementById("progressText");

        async function loadChecklist() {
            try {
                const res = await fetch(`${API}/api/games/${GAME_ID}/checklist`, {
                    headers: { Authorization: "Bearer " + token }
                });
                if (res.status === 401) return handleUnauthorized();

                const list = await res.json().catch(() => []);
                itemsEl.innerHTML = "";

                if (!Array.isArray(list) || list.length === 0) {
                    itemsEl.innerHTML = "<li style='color: var(--muted);'>No items yet.</li>";
                    return;
                }

                for (const item of list) {
                    const id = item.checklist_item_id || item.id;
                    const li = document.createElement("li");
                    li.className = `card item ${item.completed ? "done" : ""}`;
                    li.dataset.id = id;

                    li.innerHTML = `
        <label class="check-row">
          <input type="checkbox" class="toggle" ${item.completed ? "checked" : ""}>
          <span class="desc">${item.description}</span>
          <input type="text" class="edit input" value="${item.description}" style="display:none;">
        </label>
        <div style="display:flex; justify-content: flex-end; gap:0.5rem;">
          <button class="button btn-edit edit-btn">Edit</button>
          <button class="button btn-save save-btn" style="display:none;">Save</button>
          <button class="button btn-cancel cancel-btn" style="display:none;">Cancel</button>
          <button class="button btn-delete del">Delete</button>
        </div>`;
                    itemsEl.appendChild(li);
                }
            } catch (e) {
                toast("Error loading checklist", "error");
            }
        }

        async function loadProgress() {
            try {
                const res = await fetch(`${API}/api/games/${GAME_ID}/progress`, {
                    headers: { Authorization: "Bearer " + token }
                });
                if (!res.ok) return;
                const p = await res.json();
                progressEl.textContent = `Progress: ${p.completed}/${p.total} items, ${p.percent}% complete`;
            } catch {
                progressEl.textContent = "Progress: ...";
            }
        }

        async function refreshAll() {
            await loadChecklist();
            await loadProgress();
        }

        async function addItem() {
            const description = inputEl.value.trim();
            if (!description) return;

            const res = await fetch(`${API}/api/games/${GAME_ID}/checklist`, {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                    Authorization: "Bearer " + token
                },
                body: JSON.stringify({ description, completed: false })
            });

            if (!res.ok) {
                const data = await res.json().catch(() => ({}));
                toast(data.message || "Failed to add item", "error");
                return;
            }

            inputEl.value = "";
            await refreshAll();
        }

        itemsEl.addEventListener("change", async (e) => {
            if (!e.target.classList.contains("toggle")) return;
            const li = e.target.closest("li");
            const id = li.dataset.id;
            const completed = e.target.checked;

            li.classList.toggle("done", completed);

            await fetch(`${API}/api/checklist/${id}`, {
                method: "PUT",
                headers: {
                    "Content-Type": "application/json",
                    Authorization: "Bearer " + token
                },
                body: JSON.stringify({ completed })
            });
            loadProgress();
        });

        itemsEl.addEventListener("click", async (e) => {
            const li = e.target.closest("li");
            if (!li) return;
            const id = li.dataset.id;
            const descSpan = li.querySelector(".desc");
            const editInput = li.querySelector(".edit");
            const editBtn = li.querySelector(".edit-btn");
            const saveBtn = li.querySelector(".save-btn");
            const cancelBtn = li.querySelector(".cancel-btn");

            if (e.target.classList.contains("edit-btn")) {
                descSpan.style.display = "none";
                editInput.style.display = "inline-block";
                editBtn.style.display = "none";
                saveBtn.style.display = "inline-block";
                cancelBtn.style.display = "inline-block";
                editInput.focus();
            }

            if (e.target.classList.contains("cancel-btn")) {
                editInput.value = descSpan.textContent;
                descSpan.style.display = "inline";
                editInput.style.display = "none";
                editBtn.style.display = "inline-block";
                saveBtn.style.display = "none";
                cancelBtn.style.display = "none";
            }

            if (e.target.classList.contains("save-btn")) {
                const description = editInput.value.trim();
                if (description && description !== descSpan.textContent) {
                    await fetch(`${API}/api/checklist/${id}`, {
                        method: "PUT",
                        headers: {
                            "Content-Type": "application/json",
                            Authorization: "Bearer " + token
                        },
                        body: JSON.stringify({ description })
                    });
                    descSpan.textContent = description;
                }
                descSpan.style.display = "inline";
                editInput.style.display = "none";
                editBtn.style.display = "inline-block";
                saveBtn.style.display = "none";
                cancelBtn.style.display = "none";
            }

            if (e.target.classList.contains("del")) {
                await fetch(`${API}/api/checklist/${id}`, {
                    method: "DELETE",
                    headers: { Authorization: "Bearer " + token }
                });
                refreshAll();
            }
        });

        addBtn.addEventListener("click", addItem);
        inputEl.addEventListener("keydown", (e) => {
            if (e.key === "Enter") addItem();
        });

        async function loadGameHeader() {
            const h1 = document.getElementById("gameTitle");
            const img = document.getElementById("gameThumb");

            const fallbackThumb =
                "data:image/svg+xml;utf8," +
                encodeURIComponent(`<svg xmlns="http://www.w3.org/2000/svg" width="160" height="160">
  <rect width="100%" height="100%" fill="#1f2937"/>
  <text x="50%" y="50%" dominant-baseline="middle" text-anchor="middle"
        fill="#9ca3af" font-family="Segoe UI, Arial" font-size="14">No Image</text>
</svg>`);

            const setUI = (g) => {
                const title = (g.title || "").trim();
                const run = (g.run_type || "").trim();
                const label = run ? `${title} - ${run}` : (title || "Game Checklist");
                h1.textContent = label;
                document.title = `${label} - Checklist`;

                const src = g.thumbnail_url || g.cover_url || "";
                if (src) {
                    img.src = src;
                    img.alt = (g.title || "cover") + " thumbnail";
                    img.style.display = "block";
                    img.onerror = () => { img.onerror = null; img.src = fallbackThumb; img.style.display = "block"; };
                } else {
                    img.src = fallbackThumb;
                    img.style.display = "block";
                }
            };

            try {
                // primary: direct game fetch
                const r1 = await fetch(`${API}/api/games/${GAME_ID}`, { headers: { Authorization: "Bearer " + token } });
                if (r1.ok) {
                    const g = await r1.json();
                    setUI(g);
                    return;
                }

                // fallback: list and find by id
                if (userId) {
                    const r2 = await fetch(`${API}/api/games?user_id=${userId}`, { headers: { Authorization: "Bearer " + token } });
                    if (r2.ok) {
                        const list = await r2.json().catch(() => []);
                        const g = Array.isArray(list) ? list.find(x => Number(x.game_id) === Number(GAME_ID)) : null;
                        if (g) { setUI(g); return; }
                    }
                }

                setUI({});
            } catch {
                setUI({});
            }
        }


        function handleUnauthorized() {
            localStorage.removeItem("token");
            try {
                sessionStorage.setItem("redirectAfterLogin", location.pathname + location.search + location.hash);
            } catch { }
            location.replace("/login.html");
        }

        // Initialize
        loadGameHeader();
        refreshAll();
    </script>

</body>

</html>