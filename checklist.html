<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <link rel="stylesheet" href="styles.css">
    <script src="toast.js" defer></script>
    <link rel="icon" href="favicon.ico" type="image/x-icon">
    <title>Checklist – Completionist Tracker</title>
</head>

<body>
    <div class="container">
        <div class="topbar">
            <a href="index.html" class="brand">Completionist Tracker</a>
            <nav class="nav">
                <a class="link-btn btn-ghost" href="index.html">Dashboard</a>
                <a class="link-btn btn-ghost" href="community.html">Community</a>
                <button id="logoutBtn" class="btn-secondary">Log out</button>
            </nav>
        </div>

        <div class="panel wide-panel">
            <h1 id="gameTitle">Game Checklist</h1>
            <p class="section" style="color: var(--muted)">
                Track your progress for individual game goals.
            </p>

            <div class="section">
                <span id="progressText" class="progress">Progress: ...</span>
            </div>

            <div class="form-row">
                <input id="descriptionInput" class="input" placeholder="New checklist item" autocomplete="off" />
                <button id="addBtn" class="button">Add</button>
            </div>
        </div>

        <div class="panel wide-panel">
            <ul id="items" class="list"></ul>
        </div>
    </div>

    <script>
        const API = "https://completionist-backend.onrender.com";
        const params = new URLSearchParams(window.location.search);
        const GAME_ID = Number(params.get("game_id") || 0);

        if (!GAME_ID) {
            toast("Missing game ID, returning to dashboard", "error");
            window.location.href = "index.html";
        }

        const itemsEl = document.getElementById("items");
        const inputEl = document.getElementById("descriptionInput");
        const addBtn = document.getElementById("addBtn");
        const progressEl = document.getElementById("progressText");

        async function loadChecklist() {
            const res = await fetch(`${API}/api/games/${GAME_ID}/checklist`);
            const list = await res.json().catch(() => []);
            itemsEl.innerHTML = "";

            if (!Array.isArray(list) || list.length === 0) {
                itemsEl.innerHTML = "<li style='color: var(--muted);'>No items yet.</li>";
                return;
            }

            for (const item of list) {
                const id = item.checklist_item_id || item.id;
                const li = document.createElement("li");
                li.className = "card item";
                li.dataset.id = id;

                li.innerHTML = `
          <label class="check-row">
            <input type="checkbox" class="toggle" ${item.completed ? "checked" : ""}>
            <input type="text" class="edit input" value="${item.description}">
          </label>
          <div style="display:flex; justify-content: flex-end;">
            <button class="button btn-delete del">Delete</button>
          </div>
        `;
                itemsEl.appendChild(li);
            }
        }

        async function loadProgress() {
            try {
                const res = await fetch(`${API}/api/games/${GAME_ID}/progress`);
                if (!res.ok) return;
                const p = await res.json();
                progressEl.textContent = `Progress: ${p.completed}/${p.total} items, ${p.percent}% complete`;
            } catch {
                progressEl.textContent = "Progress: ...";
            }
        }

        async function refreshAll() {
            await loadChecklist();
            await loadProgress();
        }

        async function addItem() {
            const description = inputEl.value.trim();
            if (!description) return;
            const res = await fetch(`${API}/api/games/${GAME_ID}/checklist`, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ description, completed: false })
            });
            if (!res.ok) {
                const data = await res.json().catch(() => ({}));
                toast(data.message || "Failed to add item", "error");
                return;
            }
            inputEl.value = "";
            await refreshAll();
        }

        itemsEl.addEventListener("change", async (e) => {
            if (!e.target.classList.contains("toggle")) return;
            const li = e.target.closest("li");
            const id = li.dataset.id;
            const completed = e.target.checked;
            await fetch(`${API}/api/checklist/${id}`, {
                method: "PUT",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ completed })
            });
            loadProgress();
        });

        itemsEl.addEventListener("keydown", async (e) => {
            if (e.key !== "Enter" || !e.target.classList.contains("edit")) return;
            const li = e.target.closest("li");
            const id = li.dataset.id;
            const description = e.target.value.trim();
            await fetch(`${API}/api/checklist/${id}`, {
                method: "PUT",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ description })
            });
            e.target.blur();
        });

        itemsEl.addEventListener("click", async (e) => {
            if (!e.target.classList.contains("del")) return;
            const li = e.target.closest("li");
            const id = li.dataset.id;
            await fetch(`${API}/api/checklist/${id}`, { method: "DELETE" });
            refreshAll();
        });

        addBtn.addEventListener("click", addItem);
        inputEl.addEventListener("keydown", (e) => {
            if (e.key === "Enter") addItem();
        });

        const userId = Number(localStorage.getItem("ct_user_id") || 0);

        async function loadGameTitle() {
            const h1 = document.getElementById("gameTitle");
            const fallback = () => { h1.textContent = "Game Checklist"; };

            try {
                // Try a direct game lookup
                const r1 = await fetch(`${API}/api/games/${GAME_ID}`);
                if (r1.ok) {
                    let g = await r1.json();
                    // If the API returns an array for some reason, grab the first
                    if (Array.isArray(g)) g = g[0] || {};
                    const title = (g.title || "").trim();
                    const run = (g.run_type || "").trim();
                    if (title) {
                        const label = run ? `${title} \u2013 ${run}` : title; // \u2013 = en dash
                        h1.textContent = label;
                        document.title = `${label} – Checklist`;
                        return;
                    }
                }

                // Fallback: fetch user’s games and find by id
                if (userId) {
                    const r2 = await fetch(`${API}/api/games?user_id=${userId}`);
                    if (r2.ok) {
                        const list = await r2.json().catch(() => []);
                        const g = Array.isArray(list) ? list.find(x => Number(x.game_id) === GAME_ID) : null;
                        if (g && g.title) {
                            const label = g.run_type ? `${g.title} \u2013 ${g.run_type}` : g.title;
                            h1.textContent = label;
                            document.title = `${label} – Checklist`;
                            return;
                        }
                    }
                }

                fallback();
            } catch {
                fallback();
            }
        }

        // Call it once on page load
        loadGameTitle();

        refreshAll();
    </script>
</body>

</html>