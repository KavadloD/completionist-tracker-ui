<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <title>Community Checklists</title>
    <link rel="stylesheet" href="styles.css" />
    <link rel="icon" href="favicon.ico" type="image/x-icon">
    <script src="toast.js" defer></script>

    <style>
        html {
            visibility: hidden
        }
    </style>
    <script>
        (async () => {
            const LOGIN_PATH = '/login.html';
            const token = localStorage.getItem('token');
            const legacyUserId = localStorage.getItem('ct_user_id');

            const rememberDest = () => {
                try {
                    sessionStorage.setItem('redirectAfterLogin', location.pathname + location.search + location.hash);
                } catch { }
            };

            const toLogin = () => {
                rememberDest();
                location.replace(LOGIN_PATH);
            };

            if (token) {
                try {
                    const res = await fetch("https://completionist-backend.onrender.com/api/auth/me", {
                        headers: { Authorization: "Bearer " + token }
                    });
                    if (!res.ok) throw new Error("unauthorized");
                    document.documentElement.style.visibility = "visible";
                    return;
                } catch {
                    localStorage.removeItem("token");
                }
            }

            if (legacyUserId) {
                console.warn("Running in legacy mode (no token)");
                document.documentElement.style.visibility = "visible";
                return;
            }

            toLogin();
        })();
    </script>

</head>

<body>
    <div class="container">
        <!-- Top Navigation Bar -->
        <header class="topbar">
            <div class="brand">Completionist Tracker</div>
            <nav class="nav">
                <a class="link-btn btn-ghost" href="index.html">Dashboard</a>
                <a class="link-btn btn-ghost" href="community.html">Community</a>
                <button id="logoutBtn" class="btn-secondary">Log out</button>
            </nav>
        </header>

        <!-- Main Content Panel -->
        <main class="panel">
            <h1>Browse Community Checklists</h1>
            <p class="section" style="color: var(--muted);">Import templates into your library and start tracking.</p>

            <div style="margin-top:10px;max-width:500px;">
                <input id="communitySearch" class="input"
                    placeholder="Search titles, tags, platform, genre, run type, author, description">
            </div>

            <div id="community-list" class="list" style="margin-top:12px;">Loading...</div>
        </main>

        <script>
            const API = "https://completionist-backend.onrender.com";
            const userId = Number(localStorage.getItem("ct_user_id") || 0);

            function authHeaders() {
                const t = localStorage.getItem("token") || "";
                return t ? { Authorization: "Bearer " + t } : {};
            }
            function handleUnauthorized() {
                localStorage.removeItem("token");
                try { sessionStorage.setItem("redirectAfterLogin", location.pathname + location.search + location.hash); } catch { }
                location.replace("/login.html");
            }
            function el(tag, props = {}, children = []) {
                const n = document.createElement(tag);
                Object.entries(props).forEach(([k, v]) => {
                    if (k === "class") n.className = v;
                    else if (k === "text") n.textContent = v;
                    else if (k === "onclick") n.onclick = v;
                    else n.setAttribute(k, v);
                });
                (Array.isArray(children) ? children : [children]).forEach(c => c && n.appendChild(c));
                return n;
            }

            let ALL_TEMPLATES = [];

            function renderList(list) {
                const container = document.getElementById("community-list");
                container.innerHTML = "";

                for (const item of list) {
                    const left = el("div", { style: "display:flex;gap:10px;align-items:center" }, [
                        item.thumbnail_url
                            ? el("img", { src: item.thumbnail_url, alt: "", style: "width:64px;height:64px;object-fit:cover;border-radius:8px;background:#111;border:1px solid #222" })
                            : null,
                        el("div", { style: "display:flex;flex-direction:column;gap:6px;line-height:1.25" }, [
                            el("div", { style: "font-weight:700", text: item.title || "" }),
                            el("div", {
                                style: "color:var(--muted);font-size:13px",
                                text: `${item.platform || ''}${item.platform && item.genre ? ' | ' : ''}${item.genre || ''}${item.items_count ? ` â€¢ ${item.items_count} items` : ''}`
                            }),
                            el("div", {
                                style: "color:var(--muted);font-size:12px",
                                text: item.created_by_username ? `by ${item.created_by_username}` : ""
                            }),
                        ])
                    ]);

                    const card = el("div", { class: "card item" }, [
                        el("div", { style: "display:flex;align-items:center;justify-content:space-between;gap:10px;flex-wrap:wrap" }, [
                            left,
                            el("button", { class: "button", text: "Import", onclick: () => importTemplate(item.community_checklist_id) })
                        ]),
                        el("div", { style: "color:var(--muted);margin-top:8px", text: item.description || "" })
                    ]);

                    container.appendChild(card);
                }

                if (!list.length) {
                    container.innerHTML = `<div style="color:var(--muted);padding:8px 0">No results</div>`;
                }
            }

            function filterTemplates(q) {
                q = (q || "").toLowerCase().trim();
                if (!q) return ALL_TEMPLATES.slice();
                const terms = q.split(/\s+/).filter(Boolean);

                return ALL_TEMPLATES.filter(t => {
                    const hay = [
                        t.title, t.platform, t.genre, t.run_type, t.tags, t.description, t.created_by_username
                    ].map(s => (s || "").toLowerCase()).join(" ");
                    return terms.every(term => hay.includes(term));
                });
            }

            function initCommunitySearch() {
                const input = document.getElementById("communitySearch");
                if (!input) return;
                let timer;
                input.addEventListener("input", () => {
                    clearTimeout(timer);
                    timer = setTimeout(() => renderList(filterTemplates(input.value)), 120);
                });
            }

            async function loadCommunityChecklists() {
                const res = await fetch(`${API}/api/community`, { headers: authHeaders() });
                if (res.status === 401) return handleUnauthorized();
                ALL_TEMPLATES = await res.json().catch(() => []);
                renderList(ALL_TEMPLATES);
            }

            async function importTemplate(id) {
                if (!userId) { toast("Please log in to import checklists.", "info"); return; }
                const res = await fetch(`${API}/api/community/import/${id}`, {
                    method: "POST",
                    headers: Object.assign({ "Content-Type": "application/json" }, authHeaders()),
                    body: JSON.stringify({ user_id: userId })
                });
                if (res.status === 401) return handleUnauthorized();
                const result = await res.json().catch(() => ({}));
                if (res.ok) {
                    toast("Checklist imported. Opening your new checklist.", "success");
                    window.location.href = `checklist.html?game_id=${result.new_game_id}`;
                } else {
                    toast(result.message || "Import failed", "error");
                }
            }

            // Logout
            const logoutBtn = document.getElementById("logoutBtn");
            if (logoutBtn) {
                logoutBtn.addEventListener("click", () => {
                    localStorage.removeItem("token");
                    try { sessionStorage.removeItem("redirectAfterLogin"); } catch { }
                    location.replace("/login.html");
                });
            }

            // Init
            loadCommunityChecklists();
            initCommunitySearch();
        </script>
</body>

</html>