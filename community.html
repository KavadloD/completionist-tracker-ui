<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <title>Community Checklists</title>
    <link rel="stylesheet" href="styles.css" />
    <script src="toast.js" defer></script>
</head>

<body>
    <div class="container">
        <!-- Top Navigation Bar -->
        <header class="topbar">
            <div class="brand">Completionist Tracker</div>
            <nav class="nav">
                <a class="link-btn btn-ghost" href="dashboard.html">Dashboard</a>
            </nav>
        </header>

        <!-- Main Content Panel -->
        <main class="panel">
            <h1>Browse Community Checklists</h1>
            <p class="section" style="color: var(--muted);">
                Import templates into your library and start tracking.
            </p>
            <div id="community-list" class="list">Loading...</div>
        </main>
    </div>

    <script>
        const API = "https://completionist-backend.onrender.com";
        const userId = Number(localStorage.getItem("ct_user_id") || 0);

        async function loadCommunityChecklists() {
            const res = await fetch(`${API}/api/community`);
            const data = await res.json();

            const container = document.getElementById("community-list");
            if (!Array.isArray(data) || data.length === 0) {
                container.innerHTML = `
          <div class="card">
            <span style="color: var(--muted);">No community templates available.</span>
          </div>`;
                return;
            }

            container.innerHTML = "";
            data.forEach(item => {
                const div = document.createElement("div");
                div.className = "card item";
                div.innerHTML = `
          <div style="display: flex; align-items: center; justify-content: space-between; gap: 10px; flex-wrap: wrap;">
            <div>
              <div style="font-weight: 700;">${item.title}</div>
              <div style="color: var(--muted); font-size: 13px;">${item.platform || ""} ${item.genre || ""}</div>
            </div>
            <button class="button" data-import="${item.community_checklist_id}">Import</button>
          </div>
          <div style="color: var(--muted); margin-top: 8px;">${item.description || ""}</div>
        `;
                container.appendChild(div);
            });

            container.onclick = async (e) => {
                const id = e.target.getAttribute("data-import");
                if (!id) return;

                if (!userId) {
                    toast("Please log in to import checklists.", "info");
                    return;
                }

                const res = await fetch(`${API}/api/community/import/${id}`, {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ user_id: userId })
                });

                const result = await res.json();
                if (res.ok) {
                    toast("Checklist imported. Opening your new checklist.", "success");
                    window.location.href = `checklist.html?game_id=${result.new_game_id}`;
                } else {
                    toast(result.message || "Import failed", "error");
                }
            };
        }

        loadCommunityChecklists();
    </script>
</body>

</html>